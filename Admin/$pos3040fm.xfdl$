<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="pos3040fm" width="1396" height="619" titletext="New Form" onload="pos3040fm_onload">
    <Layouts>
      <Layout height="619" mobileorientation="landscape" width="1396">
        <ChartJS id="chtSalary" taborder="1" text="ChartJS00" left="116" top="75" width="1165" height="470"/>
      </Layout>
    </Layouts>
    <Objects>
      <Dataset id="ds_salaryStats">
        <ColumnInfo>
          <Column id="work_month" type="STRING" size="10"/>
          <Column id="total_hours" type="BIGDECIMAL" size="256"/>
          <Column id="total_payout" type="BIGDECIMAL" size="256"/>
          <Column id="total_bonus" type="INT" size="256"/>
          <Column id="total_deduction" type="INT" size="256"/>
          <Column id="emp_count" type="INT" size="256"/>
          <Column id="reg_date" type="DATETIME" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
    <Script type="xscript5.1"><![CDATA[this.pos3040fm_onload = function(obj:nexacro.Form,e:nexacro.LoadEventInfo)
{
	this.fn_getSalaryStats();
	this.fn_drawSalaryChart();
};



/**
 * @description 통계 데이터를 서버에서 가져오는 함수
 */
this.fn_getSalaryStats = function()
{
    // 1. 서비스 경로 및 파라미터 설정
    var strSvcId    = "getSalaryStats";
    var strSvcUrl   = "SvcUrl::pos/getSalaryStats.do";      // 서버의 Controller 매핑 주소
    var strInDs     = "";                            // 서버로 보낼 데이터셋 (조회조건이 있다면 추가)
    var strOutDs    = "ds_salaryStats=out_stats";    // [중요] 서버 결과(out_stats)를 우리 데이터셋(ds_salaryStats)에 매핑
    var strArg      = "";                            // 추가 인자값
    var strCallback = "fn_statCallback";             // 통신 완료 후 호출될 콜백 함수명
    
    // 2. 트랜잭션 호출
    this.transaction(strSvcId, strSvcUrl, strInDs, strOutDs, strArg, strCallback);
};

/**
 * @description 트랜잭션 결과 처리 콜백
 */
this.fn_statCallback = function(svcId, errCode, errMsg)
{
    if (errCode < 0) {
        this.alert("데이터를 가져오지 못했습니다: " + errMsg);
        return;
    }
    
    if (svcId == "getSalaryStats") {
        // 데이터가 ds_salaryStats에 들어왔으므로 차트를 다시 그립니다.
        this.fn_drawSalaryChart();
    }
};


this.fn_drawSalaryChart = function()
{
    var chart = this.chtSalary; 
    var canvas = chart.getCanvas();
    var ds = this.ds_salaryStats;

    // 원 단위를 '만 원' 단위로 변환하여 임시 컬럼에 저장
    if (!ds.getColumnInfo("total_payout_man")) {
        ds.addColumn("total_payout_man", "BIGDECIMAL");
    }
    for (var i = 0; i < ds.rowcount; i++) {
        var nRawValue = ds.getColumn(i, "total_payout");
        // 만 원 단위로 반올림 계산
        ds.setColumn(i, "total_payout_man", Math.round(nRawValue / 10000));
    }
    ds.set_enableevent(true);

    DxChart.reset(canvas);
    
    var chartObj = new DxChartBar({
        id: canvas.id,
        elem: canvas,
        binddataset: ds, 
        // 가공된 만 원 단위 컬럼(total_payout_man)을 바인딩
        data: ["bind:total_payout_man"],      
        options: {
            title: { Text: "월별 급여 지출 현황 (단위: 만 원)" },
            margin: { Left: 100, Right: 30, Top: 50, Bottom: 50 }, 
            xaxis: {
                Labels: ["bind:work_month"], 
                Tickmarks: true
            },
            yaxis: {
                // Y축 단위 및 콤마 설정
                ScaleUnitsPost: " 만 원", // 숫자 뒤에 ' 만 원' 표시
                ScaleThousand: true,      // 천 단위 콤마(,) 표시
                Tickmarks: true
            },
            colors: ['#2ecc71'], 
            tooltips: {
                // 툴팁에 나오는 값 뒤에도 ' 만 원' 표시
                Data: '%{value_formatted} 만 원'
            }
        }
    }).grow(); 
};
]]></Script>
  </Form>
</FDL>
