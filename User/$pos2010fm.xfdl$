<?xml version="1.0" encoding="utf-8"?>
<FDL version="2.1">
  <Form id="pos2010fm" width="1600" height="740" titletext="New Form" onload="pos2010fm_onload" background="" onactivate="pos2010fm_onactivate">
    <Layouts>
      <Layout height="740" mobileorientation="landscape" width="1600">
        <Button id="btnLogout" taborder="0" text="로그아웃" left="1482" top="3" width="108" height="45" onclick="btnLogout_onclick" cssclass="btn_login"/>
        <Button id="Button00" taborder="1" left="20" top="0" width="170" height="50" cssclass="logo" onclick="Button00_onclick" background="url('theme://images/pos_Logo.png') repeat right bottom" border="0px none"/>
        <Static id="staUser" taborder="2" top="13" width="110" height="24" cssclass="sta_TF_Welcome" onclick="staUser_onclick" text="역할, 사용자 이름" left="1355"/>
        <Button id="btnNotice" taborder="3" top="13" width="24" height="24" onclick="btnNotice_onclick" cssclass="btn_TF_PushN" right="265"/>
      </Layout>
    </Layouts>
    <Script type="xscript5.1"><![CDATA[this.fvApp = nexacro.getApplication();

this.btnLogout_onclick = function(obj:nexacro.Button,e:nexacro.ClickEventInfo)
{
		var sMsgId = "confirm.logout";			//메세지ID
		var arrArg = "";						//메세지취환될값 배열[생략가능]
		var sPopId = sMsgId;					//메세지팝업ID[생략가능]	*해당화면에서 메시지 중복사용시 구분되는값을 넣어줘야함
		var sMsgCallback = "fnMsgCallback";		//메세지콜백[생략가능] 		* confirm성 메시지를 사용 시 반드시 필요
		
		// 로그아웃 하시겠습니까?
		this.gfnAlert(sMsgId, arrArg, sPopId, sMsgCallback);	
};
// /************************************************************************************************
//  * CALLBACK 콜백 처리부분(Transaction, Popup)
//  ************************************************************************************************/
// /**
//  * @description 메세지 콜백
// */

this.fnMsgCallback = function (strId, strVal)
{
	if(strId == "confirm.logout"){
		if(strVal){
		    this.fvApp.gvLogOut = "Y";
			this.fvApp.VF.separatesize = "0,0,*,0";
		} 
		else{
			this.fvApp.gvLogOut = "N";
		}		
	}
};

this.fnUpdateUserInfo = function(obj:nexacro.NormalDataset, e:nexacro.DSLoadEventInfo)
{
    // e.reason == 0 은 데이터가 성공적으로 로드(Load)되었음
    if (e.reason == 0) {
        var sRole = obj.getColumn(0, "role");
		var sRoleNm = (sRole == "Admin" ? "관리자" : "사용자");
		var sName = obj.getColumn(0, "name");
        this.staUser.text= sRoleNm + "   "+sName + "님"; 
    }
};

this.pos2010fm_onload = function(obj:nexacro.Form,e:nexacro.LoadEventInfo)
{
	// gdsAccount의 데이터가 로드되거나 변경될 때 실행될 함수를 연결
	this.fvApp.gdsAccount.addEventHandler("onload", this.fnUpdateUserInfo, this);
	this.fn_searchTable();
};

//조회 함수: 서버에 저장된 테이블 레이아웃 요청
this.fn_searchTable = function()
{
    var sSvcId    = "searchLayout";
    var sUrl      = "SvcUrl::pos/searchTableLayout.do"; 
    var inData    = ""; 
    var outData   = "ds_table=ds_table";
    var sArg      = "";
    var sCallback = "fnCallback";
    
    this.gfnTransaction(sSvcId, sUrl, inData, outData, sArg, sCallback);
};

// 트랜잭션 콜백 함수
this.fnCallback = function(svcId, errCode, errMsg)
{
    if (errCode < 0) {
        this.alert("조회 오류: " + errMsg);
        return;
    }
    
    // 조회 서비스가 성공적으로 끝났을 때만 테이블을 그림
    if (svcId == "searchLayout") {
        this.fn_drawTables(); 
    }
};

// 테이블 그리기 (사용자 화면용)
this.fn_drawTables = function()
{
    // 기존 UI 초기화
    var arrComp = this.components;
    for (var i = arrComp.length - 1; i >= 0; i--) {
        if (arrComp[i].name.indexOf("divTable_") == 0) {
            this.removeChild(arrComp[i].name).destroy();
        }
    }

    // DB에서 가져온 데이터셋(ds_table) 루프
    for (var i = 0; i < this.ds_table.rowcount; i++) {
        var sId   = this.ds_table.getColumn(i, "TABLE_ID");
        var nLeft = this.ds_table.getColumn(i, "POS_LEFT");
        var nTop  = this.ds_table.getColumn(i, "POS_TOP");
        
        this.fn_makeUserTableDiv(sId, nLeft, nTop);
    }
};

// 사용자용 테이블 Div 생성 (드래그 제외)
this.fn_makeUserTableDiv = function(sId, nLeft, nTop)
{
    var sDivId = "divTable_" + sId;
    var objDiv = new Div();
    
    // 관리자 화면과 동일한 크기로 생성
    objDiv.init(sDivId, nLeft, nTop, 200, 200);
    
    // 디자인 설정
    objDiv.background="#ffffff"; // 사용자 화면은 보통 흰색/밝은색 배경
    objDiv.border="2px solid #5d59d7";
    objDiv.borderRadius="8px";
    objDiv.u_tableId = sId;

    // [중요] 드래그는 빼고, 클릭하면 주문창이 뜨도록 이벤트 연결
    objDiv.addEventHandler("onclick", this.divTable_onclick, this);
    
    this.addChild(sDivId, objDiv);
    objDiv.show();

    // 상단에 테이블 번호 표시
    var objStaNum = new Static();
    objStaNum.init("staNum", 10, 10, 100, 30);
    objStaNum.text=sId + "번 테이블";
    objStaNum.font="bold 14pt 'Arial'";
    objStaNum.enable=false; // 클릭 이벤트 방해 방지
    objDiv.form.addChild("staNum", objStaNum);
    objStaNum.show();
};
]]></Script>
    <Objects>
      <Dataset id="ds_table">
        <ColumnInfo>
          <Column id="TABLE_ID" type="STRING" size="256"/>
          <Column id="POS_LEFT" type="INT" size="256"/>
          <Column id="POS_TOP" type="INT" size="256"/>
          <Column id="TABLE_NAME" type="STRING" size="256"/>
        </ColumnInfo>
      </Dataset>
    </Objects>
  </Form>
</FDL>
